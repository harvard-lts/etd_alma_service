# Build all images and run all containers
# `docker-compose -f docker-compose-local.yml up -d --build --force-recreate`

version: '3.7'

services:

  etd-alma-service:
    container_name: 'etd-alma-service'
    build:
      context: './'
      dockerfile: './DockerfileLocal'
    volumes:
      - './:/home/etdadm'
      - '/tmp:/tmp'
    env_file:
      - '.env'
    environment:
      - CELERY_LOG_LEVEL=DEBUG
      - CONSUME_QUEUE_NAME=etd_in_storage
    ports:
      # Worker API
      - '10601:8081'
    networks:
      - etd-net

  jaeger_dashboard:
    image: jaegertracing/all-in-one
    ports:
      - "4317:4317"
      - "4318:4318"
      - "5775:5775"
      - "5778:5778"
      - "9411:9411"
      - "14250:14250"
      - "14268:14268"
      - "14269:14269"
      - "6831:6831"
      - "6832:6832"
      - "16686:16686"
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: any
    networks:
      - etd-net 

# Create a custom docker network if it does not exist already
networks:
 etd-net:
    name: etd-net
